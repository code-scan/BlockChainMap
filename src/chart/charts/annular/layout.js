'use strict';var _Mathabs=Math.abs,_Mathacos=Math.acos,_Mathasin=Math.asin,_Mathsqrt=Math.sqrt,_Mathsin=Math.sin,_Mathcos=Math.cos,_MathPI=Math.PI,_Mathmin=Math.min;Object.defineProperty(exports,'__esModule',{value:!0});function CircularLayout(){this.nodes=null,this.posSet=null,this.depthPosSet=null,this.drawnBiComps=null,this.bc=null,this.nodeHeights={},this.node2BiComp={},this.width=100}var p=CircularLayout.prototype;p.layout=function(a,b,c){if(c=c||{},c.width&&(this.width=c.width),this.init(a,b),this.posSet=Array(this.nodes.length),this.depthPosSet=Array(this.nodes.length),this.bc=this.createBicconnects(),!this.bc)return console.log('layout err'),null;var d=this.__layout(this.bc),f=this.nodes.map(function(h){return{x:h.x||0,y:h.y||0}});return{positions:f,origin:d}},p.init=function(a,b){var f=[],h={},l;a.forEach(function(q,u){l={id:q.id,_index:u,links:[]},f.push(l),h[l.id]=l});var n,o;b.forEach(function(q){n=h[q.from],o=h[q.to],n.links=n.links||[],n.links.push(o._index),o.links=o.links||[],o.links.push(n._index)}),this.nodes=f},p.createBicconnects=function(){function a(u){o++,c[u]=1,f[u]=d[u]=++q;for(var v=void 0,w=b[u].links,z=0;z<w.length;z++)if(v=w[z],0!=c[v])v!=l[u]&&(f[u]=_Mathmin(f[u],f[v]));else if(l[v]=u,h.push({from:u,to:v}),a(v),f[u]=_Mathmin(f[u],f[v]),-1==l[u]&&2<=b[u].links.length||f[v]>=d[u]){var A=[],B={};for(A.push(h[h.length-1].to),B[h[h.length-1].to]=!0;h[h.length-1].from!=u;){var C=h.pop();B[C.from]||(A.push(C.from),B[C.from]=!0),B[C.to]||(A.push(C.to),B[C.to]=!0)}h.pop(),B[u]||(A.push(u),B[u]=!0),n.push(A)}}var b=this.nodes,c=Array(this.nodes.length),d=Array(this.nodes.length),f=Array(this.nodes.length),h=[],l=Array(this.nodes.length),n=[],o=0;l[0]=-1;for(var q=0,u=0;u<this.nodes.length;u++)c[u]=0;return a(0),o==b.length?n:null},p.__layout=function(a){var b=-1,c=null,d=this.nodes;a.forEach(function(v,w){v.length>b&&(b=v.length,c=w)}),a[c].forEach(function(v){d[v].delete=!0});for(var v=0;v<a.length;v++)if(3<a[v].length)for(var w=0;w<a[v].length;w++)this.node2BiComp[a[v][w]]=v;var f=a[c];this.drawnBiComps=Array(f.length),this.drawnBiComps[c]=!0;var h=f.length,l=this.width*h/(2*_MathPI),o=0,q=0|l,u=0|l;f=this.sortInnerCircle(f);for(var v=0;v<f.length;v++)d[f[v]].test=v,d[f[v]].x=q+_Mathcos(o)*l,d[f[v]].y=u-_Mathsin(o)*l,this.posSet[f[v]]=!0,o+=2*_MathPI/h;return this.SetOuterCircle(c,l,q,u,-1),{x:q,y:u}},p.sortInnerCircle=function(a){for(var b=[],c=[],d={},z=0;z<a.length;z++)d[a[z]]=!0;for(var A,z=0;z<a.length;z++)A=this.NoOfChildren(a[z],d),4<A?b.push(a[z]):c.push(a[z]);var f=Array(a.length),h=b.length,l=c.length,n,o;0==h?(n=l,o=0):0==l?(o=h,n=0):h>l?(n=1,o=0|h/l):(o=1,n=0|l/h);var q=0,u=void 0,v=void 0,w=void 0;for(v=0,w=0;v<b.length&&w<c.length;){for(u=0;u<o&&v<b.length;u++)f[q++]=b[v++];for(u=0;u<n&&w<c.length;u++)f[q++]=c[w++]}for(;v<b.length;)f[q++]=b[v++];for(;w<c.length;)f[q++]=c[w++];return f},p.NoOfChildren=function(a,b){for(var l,c=0,d=this.nodes,f=d[a].links,h=0;h<f.length;h++)l=f[h],this.posSet[l]||b[l]||c++;return 7<c&&(c=7),c},p.SetOuterCircle=function(a,b,c,d,f){for(var h=this.nodes,l=0,n=0,o=void 0,q={},H=0;H<this.bc[a].length;H++){o=h[this.bc[a][H]].links;for(var J,I=0;I<o.length;I++)J=o[I],this.posSet[J]||(l+=this.NoOfChildren(J,q)+1,q[J]=!0,n++)}var u=1.5*b,v=0|2*_MathPI*u/32,w=2*_MathPI/v;v<1.2*l?(u=1.2*32*l/(2*_MathPI),w=2*_MathPI/(1.2*l),l*=1.2):l=v,10<l&&-1!=f&&(l+=5),l|=0;for(var z=Array(l),A=Array(l),H=0;H<z.length;H++)z[H]=-1,A[H]=-1;var B,C,D,E,F;if(F=2*_MathPI/this.bc[a].length,-1!=f){B=h[f].x,C=h[f].y,D=_Mathasin((d-C)/_Mathsqrt((B-c)*(B-c)+(C-d)*(C-d))),E=_Mathacos((B-c)/_Mathsqrt((B-c)*(B-c)+(C-d)*(C-d))),E>_MathPI/2&&(D=_MathPI-D),0>D&&(D+=2*_MathPI);var H=(0|D/w)%z.length;z[H]=0|D/F,A[H]=-2,10<z.length&&(z[(H+1)%z.length]=0|D/F,z[(H+2)%z.length]=0|D/F,z[(H-1+z.length)%z.length]=0|D/F,z[(H-2+z.length)%z.length]=0|D/F,A[(H+1)%A.length]=-2,A[(H+2)%A.length]=-2,A[(H-1+A.length)%A.length]=-2,A[(H-2+A.length)%A.length]=-2)}for(var G={},H=0;H<this.bc[a].length;H++){o=h[this.bc[a][H]].links;for(var I=void 0,J=0,M=0;M<o.length;M++)I=o[M],this.posSet[I]||(J+=this.NoOfChildren(I,G)+1,G[I]=!0);if(0!=J){B=h[this.bc[a][H]].x,C=h[this.bc[a][H]].y,D=_Mathasin((d-C)/_Mathsqrt((B-c)*(B-c)+(C-d)*(C-d))),E=_Mathacos((B-c)/_Mathsqrt((B-c)*(B-c)+(C-d)*(C-d))),E>_MathPI/2&&(D=_MathPI-D),0>D&&(D+=2*_MathPI);var K=this.BestFreePositionsForAll(0|D/w-J/2,z,A,J,0|D/F,c,d,w,u,this.bc[a].length),L=K*w;if(!(0>L))for(var M=0;M<o.length;M++)if(I=o[M],!this.posSet[I]){this.posSet[I]=!0;for(var N=this.NoOfChildren(I,G),O=0;O<N/2;O++)A[K%A.length]=-3,z[K%A.length]=0|D/F,K++,L+=w,L>2*_MathPI&&(L-=2*_MathPI);h[I].x=c+_Mathcos(L)*u,h[I].y=d-_Mathsin(L)*u,A[K%A.length]=I,z[K%A.length]=0|D/F,K++,L+=w,L>2*_MathPI&&(L-=2*_MathPI);for(var O=0;O<N/2;O++)A[K%A.length]=-3,z[K%A.length]=0|D/F,K++,L+=w,L>2*_MathPI&&(L-=2*_MathPI)}}}for(var H=0;H<this.bc[a].length;H++){o=h[this.bc[a][H]].links;for(var I=void 0,J=0;J<o.length;J++)if(I=o[J],!!G[I]){B=h[I].x,C=h[I].y,D=_Mathasin((d-C)/_Mathsqrt((B-c)*(B-c)+(C-d)*(C-d))),E=_Mathacos((B-c)/_Mathsqrt((B-c)*(B-c)+(C-d)*(C-d))),E>_MathPI/2&&(D=_MathPI-D),0>D&&(D+=2*_MathPI);for(var K=0;K<this.posSet.length;K++)this.depthPosSet[K]=this.posSet[K];this.EachNodeHeight(I),this.DFSSetPos(I,D,u-b)}}},p.BestFreePositionsForAll=function(a,b,c,d,f,h,l,n,o,q){var u=a,v=this.nodes;0>a&&(u+=b.length);for(var w=0,z=0,A=-1,B=!1,C=!1,D=!1,E=0,F=0,G=0;!B&&!(D&&C);){for(w=u;w<u+d&&-1==b[w%b.length];w++);if(!(w<u+d))B=!0;else if(b[w%b.length]>f&&b[w%b.length]-f<0.7*q||f-b[w%b.length]>0.7*q)z=(w-u+b.length)%b.length,A=u,u-=d-z,0>u&&(u+=b.length),C=!0;else{E++;var H=w-u;H>F&&(F=H,G=u),E>3*b.length?(u=G,B=!0):(u=(w+1)%b.length,D=!0)}}if(D&&C){w=A-1;var H=w-1,I=0,J=(w%b.length+b.length)%b.length;for((b[J]>f&&b[J]-f<0.7*q||f-b[J]>0.7*q)&&(H--,w--);I<d-z;){if(-1==b[(H+b.length)%b.length]){if(-2==c[(H+b.length)%b.length])return-1;for(var K=H;K<w-I;K++)0<c[(K+1+b.length)%b.length]&&(v[c[(K+1+b.length)%b.length]].x=h+_Mathcos(n*K)*o,v[c[(K+1+b.length)%b.length]].y=l-_Mathsin(n*K)*o),c[(K+b.length)%b.length]=c[(K+1+b.length)%b.length],b[(K+b.length)%b.length]=b[(K+1+b.length)%b.length];I++}H--}u=(w-I+1+c.length)%c.length}return u},p.EachNodeHeight=function(a){for(var b=this.nodes,c=b[a].links,d=void 0,f=0,h={},l=0;l<c.length;l++)d=c[l],this.depthPosSet[d]||h[d]||(this.depthPosSet[d]=!0,h[d]=!0);for(var l=0;l<c.length;l++)d=c[l],h[d]&&(f+=this.EachNodeHeight(d));return this.nodeHeights[a]=f,f+1},p.DFSSetPos=function(a,b,c){var d=this.node2BiComp[a],f=this.nodes;if(d!=void 0&&!this.drawnBiComps[d]){var h=d,l=f[a].x,n=f[a].y,o=this.width*this.bc[h].length/(2*_MathPI),q=2*_MathPI/this.bc[h].length,u=b-_MathPI-q;0>u&&(u+=2*_MathPI),l+=4*(_Mathcos(b)*o),n-=4*(_Mathsin(b)*o),this.drawnBiComps[h]=!0,this.bc[h]=this.sortInnerCircle(this.bc[h]);for(var v=!1,w=0;w<this.bc[h].length;w++)this.posSet[this.bc[h][w]]||(f[this.bc[h][w]].x=l+_Mathcos(u)*o,f[this.bc[h][w]].y=n-_Mathsin(u)*o,this.posSet[this.bc[h][w]]=!0,v=!0,u-=q,0>u&&(u+=2*_MathPI));v&&(f[a].x+=3*_Mathcos(b)*o,f[a].y-=3*_Mathsin(b)*o,this.SetOuterCircle(h,o,l,n,a))}else{var h=f[a].links,l,n=b+_MathPI/2;n>2*_MathPI&&(n-=2*_MathPI);for(var o=0,q=1e3,u=1e3,v=-1,w=-1,z=-2,A=-3,B={},J=0;J<h.length;J++)l=h[J],this.posSet[l]||B[l]||(o++,B[l]=!0,this.nodeHeights[l]<q?(u=q,z=w,q=this.nodeHeights[l],w=l):this.nodeHeights[l]<u&&(u=this.nodeHeights[l],z=l),this.nodeHeights[l]>=v&&(v=this.nodeHeights[l],A=l));if(0==o)return;var C=_MathPI/(o+1);n-=C,0>n&&(n+=2*_MathPI);var D=n;2<o&&(C=2*_MathPI/o,n=b+_MathPI-3*C/2,n>2*_MathPI&&(n-=2*_MathPI),D=b+_MathPI-C/2,D>2*_MathPI&&(D-=2*_MathPI)),h=f[a].links;var E=72,F;this.width*o/(2*_MathPI)>E&&(E=this.width*o/(2*_MathPI)),F=E;var G=100,H=f[a].x,I=f[a].y;2<o&&(f[a].x=H+_Mathcos(b)*E*((u+1)%100),f[a].y=I-_Mathsin(b)*E*((u+1)%100),H=f[a].x,I=f[a].y,setOffset(f[w],H+_Mathcos(D)*E,I-_Mathsin(D)*E),f[w].test='min1',setOffset(f[z],H+_Mathcos(D+C)*E,I-_Mathsin(D+C)*E),f[z].test='min2',8<this.nodeHeights[A]&&(E=256),setOffset(f[A],H+_Mathcos(D-o/2*C)*E,I-_Mathsin(D-o/2*C)*E),f[A].test='maxId'),B={};for(var J=0;J<h.length;J++)l=h[J],this.posSet[l]||B[l]||(E=8<this.nodeHeights[l]?256:F,this.posSet[l]=!0,B[l]=!0,(l!=w&&l!=z&&l!=A||2>=o)&&(setOffset(f[l],H+_Mathcos(n)*E,I-_Mathsin(n)*E),n-=C,0>n&&(n+=2*_MathPI),(1e-4>_Mathabs(n-(D-o/2*C))||1e-4>_Mathabs(n-(D-o/2*C+2*_MathPI)))&&2<o&&(n-=C,0>n&&(n+=2*_MathPI))));h=f[a].links,2<o&&(this.DFSSetPos(w,D,c*_Mathsin(C/2)),this.DFSSetPos(z,D+C,c*_Mathsin(C/2)),this.DFSSetPos(A,D-o/2*C,c*_Mathsin(C/2)),G=D,D-=C);for(var J=0;J<h.length;J++)l=h[J],B[l]&&(l!=w&&l!=z&&l!=A||2>=o)&&(this.DFSSetPos(l,D,c*_Mathsin(C/2)),D-=C,(D==G-o/2*C||D==G-o/2*C+2*_MathPI)&&2<o&&(n-=C),0>D&&(D+=2*_MathPI))}};function setOffset(a,b,c){a.x=b,a.y=c}exports.default=CircularLayout;
